<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edit-Diary | Hanjul-Diary</title>
    <link href="{{ url_for('static', filename='css/tailwind.css') }}" rel="stylesheet">
	</head>

  <body class="bg-[rgba(var(--bg-orange))]">
    <main class="min-h-screen flex flex-col justify-center">
			<section class="flex justify-center">
        <div class="logo flex flex-row items-center">
          <img src="{{ url_for('static', filename='logo.png') }}" class="w-[140px] max-[720px]:w-[100px] object-contain" />
          <p class="text-[40px] max-[720px]:text-[28px] font-[500] text-center">일기, 한마디</p>
        </div>
      </section> 

      <section>
        <div class="myDiary-edit-main-div mx-[90px] max-[720px]:mx-[40px] shadow-div-parent p-8 rounded-[12px] flex flex-col gap-6">
          <div class="pt-[20px] pb-[20px] text-[20px] font-[500] text-center">
            <span>오늘의 일기를 한 줄로 작성해주세요.</span>
            <br>
            <span class="text-[14px] text-[rgba(var(--gray))] font-[100]">수정할 내용을 입력해주세요.</span>
            <br>
            <span class="text-[14px] text-[rgba(var(--gray))] font-[100]">(50자 제한)</span>
          </div>
          <textarea placeholder="일기를 50자 이내로 작성하세요." class="diary-edit-textarea bg-[rgba(var(--bg-orange))] shadow-div-parent border rounded-[12px] px-3 py-2 focus:outline-[rgba(var(--primary))]" rows="3">{{ diary.content }}</textarea>
					<div class="flex items-center gap-8">
						<button class="diary-edit-button flex-1 mt-[8px] py-2 shadow-div-parent border rounded-[12px] hover:border-primary">수정하기</button>
						<button class="diary-delete-button flex-1 mt-[8px] py-2 text-[rgba(var(--red))] shadow-div-parent border rounded-[12px] hover:border-warn">삭제하기</button>
					</div>
          <div class="flex items-center gap-3 mt-2">
            <label class="flex items-center cursor-pointer select-none">
              <input type="checkbox" name="private" value="private" class="edit-check-private-checkbox peer sr-only" {% if diary.is_private %}checked{% endif %}>
              <span class="w-[20px] h-[20px] rounded-full shadow-div-parent border-1 border-[rgba(var(--primary))] flex items-center justify-center mr-[8px]
                peer-checked:after:w-[16px] peer-checked:after:h-[16px] peer-checked:after:rounded-full peer-checked:after:bg-[rgba(var(--primary))]"></span>
              <span class="text-[12px] font-[100] text-[rgba(var(--gray))]">이 일기는 저만 보고 싶어요.</span>
            </label>
          </div>

          {# 댓글 목록 #}
          <p class="text-[16px] font-[300] mt-[20px] mb-[12px]">댓글</p>
            {% if comments %}
              {% for comment in comments %}
                {% if comment.is_mine %}
                  <div class="diary-reply-div py-[12px] border-b border-b-[rgba(var(--primary))] flex flex-col" data-comment-id="{{ comment._id }}">
                    <div class="flex items-center justify-between">
                      <div class="diary-reply-div flex items-center">
                        <span class="diary-reply-text text-[16px] font-[100] text-[rgba(var(--gray))]">{{ comment.comment }}</span>
                        <input class="diary-reply-edit-input flex-1 bg-[rgba(var(--bg-orange))] hidden shadow-div-parent border rounded-[8px] px-3 py-2 focus:outline-[rgba(var(--primary))]" maxlength="30" value=""/>
                        <p class="reply-reveal-my-text ml-[8px] text-[10px] font-[100] text-[rgba(var(--gray))]">(내가 쓴 댓글)</p>
                      </div>
                      <div class="diary-reply-edit-div flex items-center">
                        <button class="diary-reply-edit-button ml-2 px-3 py-1 text-[10px] border rounded-[6px] shadow-div-parent hover:border-primary">수정</button>
                        <button class="diary-reply-save-button ml-2 px-3 py-1 text-[10px] border rounded-[6px] shadow-div-parent hover:border-primary hidden">저장</button>
                        <button class="diary-reply-cancel-button ml-2 px-3 py-1 text-[10px] border rounded-[6px] shadow-div-parent hover:border-primary hidden">취소</button>
                        <button class="diary-reply-delete-button ml-[12px] px-3 py-1 text-[10px] text-[rgba(var(--red))] border rounded-[6px] shadow-div-parent hover:border-warn">삭제</button>
                      </div>
                    </div>
                    {# 작성일자 #}
                    <div class="mt-1">
                      <p class="reply-created-at text-[12px] font-[100] text-[rgba(var(--gray))]">{{ comment.created_at }}</p>
                    </div>
                  </div>
                {% else %}
                  <div class="diary-reply-div py-[12px] border-b border-b-[rgba(var(--primary))]" data-comment-id="{{ comment._id }}">
                    <p class="diary-reply-text text-[16px] font-[100] text-[rgba(var(--gray))]">
                      {{ comment.comment }}
                    </p>
                    {# 작성일자 #}
                    <div class="mt-1">
                      <p class="reply-created-at text-[12px] font-[100] text-[rgba(var(--gray))]">{{ comment.created_at }}</p>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="py-[12px] border-b border-b-[rgba(var(--primary))]">
                <p class="text-[16px] font-[100] text-[rgba(var(--gray))] text-center">
                  아직 작성된 댓글이 없습니다.
                </p>
              </div>
            {% endif %}
        </div>
        <div class="mx-[90px] max-[720px]:mx-[40px]">
          <a href="{{ url_for('show_main_page') }}">
            <button class="mt-[20px] py-[16px] max-[720px]:py-[10px] shadow-div-parent text-[18px] font-[200] border rounded-[12px] hover:border-primary w-full">
              메뉴화면으로 돌아가기
            </button>
          </a>
        </div>
      </section>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const editDiaryButton = document.querySelector('.diary-edit-button');

        editDiaryButton.addEventListener('click', async () => {
          const content = document.querySelector('.diary-edit-textarea').value;
          const is_private = document.querySelector('.edit-check-private-checkbox').checked;
          const diary_id = '{{ diary._id }}';

          const response = await fetch(`/api/diary/${diary_id}/update`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              content,
              is_private
            })
          });

          const data = await response.json();

          if (response.ok) {
            alert(data.message);
            window.location.href = `/diaries/me`;
          } else {
            alert(data.message);
          }
        })
      })

      const deleteDiaryButton = document.querySelector('.diary-delete-button');
      deleteDiaryButton.addEventListener('click', async () => {
        const confirmed = confirm('정말 삭제하시겠습니까?');
        if (!confirmed) return;

        const diary_id = '{{ diary._id }}';

        const response = await fetch(`/api/diary/${diary_id}/delete`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (response.ok) {
          alert(data.message);
          window.location.href = `/diaries/me`;
        } else {
          alert(data.message);
        }
      })

      // 댓글 수정 및 삭제 API 추가
      const diaryCommentsContainer = document.querySelector('.myDiary-edit-main-div');

      diaryCommentsContainer.addEventListener('click', async (event) => {
        if (event.target.matches('.diary-reply-save-button')) {
          // 내가 작성한 댓글 수정 이벤트
          const parent = event.target.closest('.diary-reply-div');
          const text = parent.querySelector('.diary-reply-text');
          const input = parent.querySelector('.diary-reply-edit-input');
          const editBtn = parent.querySelector('.diary-reply-edit-button');
          const cancelBtn = parent.querySelector('.diary-reply-cancel-button');
          const saveBtn = parent.querySelector('.diary-reply-save-button');
          const revealMine = parent.querySelector('.reply-reveal-my-text');

          // 서버에 댓글 업데이트 요청
          const diary_id = '{{ diary._id }}';
          const comment_id = parent.dataset.commentId;
          const comment = input.value;

          // 유효성 검사 : 댓글은 빈 문자열이 될 수 없다.
          if (comment === '' || comment.trim() === '') {
            alert('댓글을 입력해주세요!');
            input.value = '';
            input.focus();
            return false;
          }

          const response = await fetch(`/diary/me/${diary_id}/comments/${comment_id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              diary_id: diary_id,
              comment_id: comment_id,
              comment: comment
            })
          });

          const data = await response.json();
          if (data.redirect) {
            alert(data.message);
            window.location.href = data.redirect;
          }

        } else if (event.target.matches('.diary-reply-cancel-button')) {
          // 수정하다가 취소 버튼을 누를 경우 -> 원래 댓글 내용으로 되돌려야 한다.
          const parent = event.target.closest('.diary-reply-div');
          const text = parent.querySelector('.diary-reply-text');
          const input = parent.querySelector('.diary-reply-edit-input');
          const editBtn = parent.querySelector('.diary-reply-edit-button');
          const cancelBtn = parent.querySelector('.diary-reply-cancel-button');
          const saveBtn = parent.querySelector('.diary-reply-save-button');
          const revealMine = parent.querySelector('.reply-reveal-my-text');

          text.textContent = input.dataset.originalComment;
          text.classList.remove('hidden');
          input.classList.add('hidden');
          saveBtn.classList.add('hidden');
          editBtn.classList.remove('hidden');
          cancelBtn.classList.add('hidden');
          revealMine.classList.remove('hidden');
          input.value = '';

        } else if (event.target.matches('.diary-reply-delete-button')) {
          // 내가 작성한 댓글 삭제 이벤트
          const confirmed = confirm('댓글을 삭제하시겠습니까?');
          if (!confirmed) return;

          const parent = event.target.closest('.diary-reply-div');
          const comment_id = parent.dataset.commentId;

          const diary_id = '{{ diary._id }}';
          const response = await fetch(`/diary/me/${diary_id}/comments/${comment_id}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              diary_id: diary_id,
              comment_id: comment_id
            })
          });

          const data = await response.json();
          if (data.redirect) {
            alert(data.message)
            window.location.href = data.redirect;
          }
        }
      })

      document.querySelectorAll('.diary-reply-edit-button').forEach(function(editBtn) {
        editBtn.addEventListener('click', function() {
          const parent = editBtn.closest('.diary-reply-div');
          const text = parent.querySelector('.diary-reply-text');
          const input = parent.querySelector('.diary-reply-edit-input');
          const cancelBtn = parent.querySelector('.diary-reply-cancel-button');
          const saveBtn = parent.querySelector('.diary-reply-save-button');
          const revealMine = parent.querySelector('.reply-reveal-my-text');

          // 원래 댓글 내용을 data 속성에 저장
          input.dataset.originalComment = text.textContent.trim();

          // 텍스트 숨기고 input 보이기
          text.classList.add('hidden');
          input.classList.remove('hidden');
          input.value = text.textContent.trim();
          editBtn.classList.add('hidden');
          cancelBtn.classList.remove('hidden'); // 취소 버튼 추가
          saveBtn.classList.remove('hidden');
          revealMine.classList.add('hidden')
          input.focus();
        });
      });

    </script>
    <script type="module">
      import { setupGraphemeLimiter } from "{{ url_for('static', filename='js/emoji-segmenter.js') }}";

      setupGraphemeLimiter({
        inputSelector: '.diary-edit-textarea',
        maxChars: 50,
        locale: 'ko'
      });
    </script>    
  </body>
</html>