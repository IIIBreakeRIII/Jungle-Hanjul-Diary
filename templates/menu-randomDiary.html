<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Random-Diary | Hanjul-Diary</title>
    <link href="{{ url_for('static', filename='css/tailwind.css') }}" rel="stylesheet">
	</head>

  <body class="bg-[rgba(var(--bg-orange))]">
    <main class="min-h-screen flex flex-col justify-center">
			<section class="flex justify-center">
        <div class="logo flex flex-row items-center">
          <img src="{{ url_for('static', filename='logo.png') }}" class="w-[140px] max-[720px]:w-[100px] object-contain" />
          <p class="text-[40px] max-[720px]:text-[28px] font-[500] text-center">ì¼ê¸°, í•œë§ˆë””</p>
        </div>
      </section> 

      <section>
        <div class="menu-randomDiary-main-div mx-[90px] max-[720px]:mx-[40px] shadow-div-parent p-8 rounded-[12px] flex flex-col">
          <div class="pt-[20px] pb-[20px] text-[20px] font-[500] text-center">
            <span>ë‹¤ë¥¸ ì‚¬ëŒì˜ ì¼ê¸°</span>
            <br>
            <span class="text-[14px] text-[rgba(var(--gray))] font-[100]">ëŒ“ê¸€ë¡œ ë‹¤ë¥¸ ì‚¬ëŒì˜ ì¼ê¸°ë¥¼ ê³µê°í•˜ê³  ì‘ì›í•´ì£¼ì„¸ìš”!</span>
          </div>
          <div class="random-diary-div bg-[rgba(var(--bg-orange))] break-words shadow-div-parent border rounded-[8px] px-[20px] py-[60px] my-[20px]">
            <p class="random-diary-text text-center">
              {{ diary.content }}
            </p>
            <p class="mt-1.5 text-[12px] text-center">
              ({{ diary.created_at }})
            </p>
          </div>
          <button class="diary-like-button flex flex-row justify-center px-[20px] py-[12px] border rounded-[8px] shadow-div-parent bg-[rgba(var(--bg-orange))] hover:border-primary">
            <p class="text-[rgba(var(--black))] font-[300]">ğŸ‘ ì¢‹ì•„ìš” &nbsp</p>
            <p class="diary-like-count-text text-[rgba(var(--primary))] font-[300]">
              {{ diary.like_count if diary.like_count is defined else 0 }}ê°œ
            </p>
          </button>
          <p class="text-[16px] font-[300] mt-[20px] mb-[12px]">ëŒ“ê¸€</p>

          {# ëŒ“ê¸€ ëª©ë¡ #}
          {% if comments %}
            {% for comment in comments %}
              {% if comment.is_mine %}
                <div class="diary-reply-div py-[12px] border-b border-b-[rgba(var(--primary))] flex flex-col" data-comment-id="{{ comment._id }}">
                  <div class="flex items-center justify-between">
                    <div class="diary-reply-div flex items-center">
                      <span class="diary-reply-text text-[16px] font-[100] text-[rgba(var(--gray))]">{{ comment.comment }}</span>
                      <input class="diary-reply-edit-input flex-1 bg-[rgba(var(--bg-orange))] hidden shadow-div-parent border rounded-[8px] px-3 py-2 focus:outline-[rgba(var(--primary))]" value=""/>
                      <p class="reply-reveal-my-text ml-[8px] text-[10px] font-[100] text-[rgba(var(--gray))]">(ë‚´ê°€ ì“´ ëŒ“ê¸€)</p>
                    </div>
                    <div class="diary-reply-edit-div flex items-center">
                      <button class="diary-reply-edit-button ml-2 px-3 py-1 text-[10px] border rounded-[6px] shadow-div-parent hover:border-primary">ìˆ˜ì •</button>
                      <button class="diary-reply-save-button ml-2 px-3 py-1 text-[10px] border rounded-[6px] shadow-div-parent hover:border-primary hidden">ì €ì¥</button>
                      <button class="diary-reply-cancel-button ml-2 px-3 py-1 text-[10px] border rounded-[6px] shadow-div-parent hover:border-primary hidden">ì·¨ì†Œ</button>
                      <button class="diary-reply-delete-button ml-[12px] px-3 py-1 text-[10px] text-[rgba(var(--red))] border rounded-[6px] shadow-div-parent hover:border-warn">ì‚­ì œ</button>
                    </div>
                  </div>
                  {# ì‘ì„±ì¼ì #}
                  <div class="mt-1">
                    <p class="reply-created-at text-[12px] font-[100] text-[rgba(var(--gray))]">{{ comment.created_at }}</p>
                  </div>
                </div>
              {% else %}
                <div class="diary-reply-div py-[12px] border-b border-b-[rgba(var(--primary))]" data-comment-id="{{ comment._id }}">
                  <p class="diary-reply-text text-[16px] font-[100] text-[rgba(var(--gray))]">
                    {{ comment.comment }}
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="py-[12px] border-b border-b-[rgba(var(--primary))]">
              <p class="text-[16px] font-[100] text-[rgba(var(--gray))] text-center">
                ì•„ì§ ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
              </p>
            </div>
          {% endif %}

          <div class="diary-add-reply mt-[40px] flex items-center">
            <input type="text" placeholder="ëŒ“ê¸€ ë‹¬ê¸°" class="diary-add-reply-input flex-1 bg-[rgba(var(--bg-orange))] shadow-div-parent border rounded-[8px] px-3 py-2 focus:outline-[rgba(var(--primary))]"/>
            <button class="diary-add-reply-button max-[540px]:text-[12px] text-[rgba(var(--black))] ml-[12px] px-[20px] py-2 max-[540px]:py-3 shadow-div-parent border rounded-[8px] hover:border-primary">
              ì…ë ¥
            </button>
          </div>
          <button class="diary-reply-random-button mt-[40px] py-2 shadow-div-parent border rounded-[12px] hover:border-primary">ë‹¤ìŒ ì¼ê¸° ë³´ê¸°</button>
        </div>
      </section>
      <div class="mx-[90px] max-[720px]:mx-[40px]">
        <button onclick="window.location.href='/diary/main'" class="mt-[20px] py-[16px] max-[720px]:py-[10px] shadow-div-parent text-[18px] font-[200] border rounded-[12px] hover:border-primary w-full">
          ë©”ë‰´í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì´ìš©í•´ì„œ .menu-randomDiary-main-div ìš”ì†Œì— ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡í•˜ê¸°
        const diaryCommentsContainer = document.querySelector('.menu-randomDiary-main-div');

        diaryCommentsContainer.addEventListener('click', async (event) => {
          if (event.target.matches('.diary-reply-save-button')) {
            // ë‚´ê°€ ì‘ì„±í•œ ëŒ“ê¸€ ìˆ˜ì • ì´ë²¤íŠ¸
            const parent = event.target.closest('.diary-reply-div');
            const text = parent.querySelector('.diary-reply-text');
            const input = parent.querySelector('.diary-reply-edit-input');
            const editBtn = parent.querySelector('.diary-reply-edit-button');
            const revealMine = parent.querySelector('.reply-reveal-my-text');

            // ì„œë²„ì— ëŒ“ê¸€ ì—…ë°ì´íŠ¸ ìš”ì²­
            const diary_id = '{{ diary._id }}';
            const comment_id = parent.dataset.commentId;
            const comment = input.value;

            // ìœ íš¨ì„± ê²€ì‚¬ : ëŒ“ê¸€ì€ ë¹ˆ ë¬¸ìì—´ì´ ë  ìˆ˜ ì—†ë‹¤.
            if (comment === '' || comment.trim() === '') {
              alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
              input.value = '';
              input.focus();
              return false;
            }

            const response = await fetch(`/diary/${diary_id}/comments/${comment_id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                diary_id: diary_id,
                comment_id: comment_id,
                comment: comment
              })
            });

            const data = await response.json();
            if (data.redirect) {
              alert(data.message);
              window.location.href = data.redirect;
            }

          } else if (event.target.matches('.diary-reply-cancel-button')) {
            // ìˆ˜ì •í•˜ë‹¤ê°€ ì·¨ì†Œ ë²„íŠ¼ì„ ëˆ„ë¥¼ ê²½ìš° -> ì›ë˜ ëŒ“ê¸€ ë‚´ìš©ìœ¼ë¡œ ë˜ëŒë ¤ì•¼ í•œë‹¤.
            const parent = event.target.closest('.diary-reply-div');
            const text = parent.querySelector('.diary-reply-text');
            const input = parent.querySelector('.diary-reply-edit-input');
            const editBtn = parent.querySelector('.diary-reply-edit-button');
            const cancelBtn = parent.querySelector('.diary-reply-cancel-button');
            const saveBtn = parent.querySelector('.diary-reply-save-button');
            const revealMine = parent.querySelector('.reply-reveal-my-text');

            text.textContent = input.dataset.originalComment;
            text.classList.remove('hidden');
            input.classList.add('hidden');
            saveBtn.classList.add('hidden');
            editBtn.classList.remove('hidden');
            cancelBtn.classList.add('hidden');
            revealMine.classList.remove('hidden');
            input.value = '';

          } else if (event.target.matches('.diary-reply-delete-button')) {
            // ë‚´ê°€ ì‘ì„±í•œ ëŒ“ê¸€ ì‚­ì œ ì´ë²¤íŠ¸
            const confirmed = confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!confirmed) return;

            const parent = event.target.closest('.diary-reply-div');
            const comment_id = parent.dataset.commentId;

            const diary_id = '{{ diary._id }}';
            const response = await fetch(`/diary/${diary_id}/comments/${comment_id}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                diary_id: diary_id,
                comment_id: comment_id
              })
            });

            const data = await response.json();
            if (data.redirect) {
              alert(data.message)
              window.location.href = data.redirect;
            }
          }
        })

        document.querySelectorAll('.diary-reply-edit-button').forEach(function(editBtn) {
          editBtn.addEventListener('click', function() {
            const parent = editBtn.closest('.diary-reply-div');
            const text = parent.querySelector('.diary-reply-text');
            const input = parent.querySelector('.diary-reply-edit-input');
            const cancelBtn = parent.querySelector('.diary-reply-cancel-button');
            const saveBtn = parent.querySelector('.diary-reply-save-button');
            const revealMine = parent.querySelector('.reply-reveal-my-text');

            // ì›ë˜ ëŒ“ê¸€ ë‚´ìš©ì„ data ì†ì„±ì— ì €ì¥
            input.dataset.originalComment = text.textContent.trim();

            // í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê³  input ë³´ì´ê¸°
            text.classList.add('hidden');
            input.classList.remove('hidden');
            input.value = text.textContent.trim();
            editBtn.classList.add('hidden');
            cancelBtn.classList.remove('hidden'); // ì·¨ì†Œ ë²„íŠ¼ ì¶”ê°€
            saveBtn.classList.remove('hidden');
            revealMine.classList.add('hidden')
            input.focus();
          });
        });

        /*
        // TODO [ì €ì¥] ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ìƒë‹¨ì— ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ì²˜ë¦¬í–ˆê¸°ì— ì¼ë‹¨ ì£¼ì„ ì²˜ë¦¬ -> ì¶”í›„ì— ì œê±°í•  ê²ƒ
        document.querySelectorAll('.diary-reply-save-button').forEach(function(saveBtn) {
          saveBtn.addEventListener('click', function() {
            const parent = saveBtn.closest('.diary-reply-div');
            const text = parent.querySelector('.diary-reply-text');
            const input = parent.querySelector('.diary-reply-edit-input');
            const editBtn = parent.querySelector('.diary-reply-edit-button');
            const revealMine = parent.querySelector('.reply-reveal-my-text');
            // input ê°’ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½
            text.textContent = input.value;
            text.classList.remove('hidden');
            input.classList.add('hidden');
            saveBtn.classList.add('hidden');
            editBtn.classList.remove('hidden');
            revealMine.classList.remove('hidden');
          });
        });
         */

        // ë‹¤ìŒ ì¼ê¸° ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelector('.diary-reply-random-button').addEventListener('click', function() {
          window.location.href = '/diary/random';
        });

        // ëŒ“ê¸€ ê²Œì‹œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelector('.diary-add-reply-button').addEventListener('click', async () => {
          const diary_id = '{{ diary._id }}';

          const commentEl = document.querySelector('.diary-add-reply-input');
          const comment = commentEl.value;

          if (!comment || comment.trim() === '') {
            alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            commentEl.focus();
            return;
          }

          const response = await fetch(`/diary/${diary_id}/comments`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              diary_id: diary_id,
              comment: comment
            })
          });

          const data = await response.json();
          if (data.redirect) {
            window.location.href = data.redirect;
          }
        });

        // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelector('.diary-like-button').addEventListener('click', async function() {
          const diary_id = '{{ diary._id }}';
          const likeCountElem = this.querySelector('.diary-like-count-text');
          const response = await fetch(`/api/diary/${diary_id}/like`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();
          console.log('ì¢‹ì•„ìš” ì‘ë‹µ status:', response.status, data);

          if (response.ok && data.like_count !== undefined) {
            likeCountElem.textContent = data.like_count + 'ê°œ';
          } else if (response.status === 400) {
            alert(data.message || 'ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤.');
          } else {
            alert(data.message || 'ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        });
      });
    </script>

    <script type="module">
      import { setupGraphemeLimiter } from "{{ url_for('static', filename='js/emoji-segmenter.js') }}";

      setupGraphemeLimiter({
        inputSelector: '.diary-add-reply-input',
        maxChars: 30,
        locale: 'ko',
      });

      setupGraphemeLimiter({
        inputSelector: '.diary-reply-edit-input',
        maxChars: 30,
        locale: 'ko',
      })
    </script>
  </body>
</html>
